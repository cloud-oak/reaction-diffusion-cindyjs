<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<script type="text/javascript" src="https://cindyjs.org/dist/snapshot/Cindy.js"></script>
		<script type="text/javascript" src="https://cindyjs.org/dist/snapshot/CindyGL.js"></script>
		<title>3dgol</title>
	</head>

	<body style="background:#000;">
		<div id="CSCanvas" class="CindyJS-widget" style="position: relative; width: 512px; height: 512px;"></div>
		<script id="cskeydown" type="text/x-cindyscript">
		</script>
		<script id="csdraw" type="text/x-cindyscript">
			colorplot((0,0), (W,0), "spectral", imagergb((0,0), (W,0), "spatial", #+[W/2,W/2], repeat->true));
			fft();
			// TODO
			colorplot((0,0), (W,0), "spectral",
				val    = imagergb((0,0), (W,0), "spectral", #);
				cinner = imagergb((0,0), (W,0), "innerkernel", #);
				couter = imagergb((0,0), (W,0), "outerkernel", #);
				[
					val.r * cinner.r - val.g * cinner.g,
					val.g * cinner.r + val.r * cinner.g,
					val.r * couter.r - val.g * couter.g,
					val.g * couter.r + val.r * couter.g
				]
			);
			ifft();
			
			colorplot((0,0), (W,0), "spatial", imagergb((0,0), (W,0), "spectral", #+[W/2,W/2], repeat->true));
			//colorplot(get(#))
			// drawimage((0,0), (W,0), "outerkernel")
			drawimage((0,0), (W,0), "spatial");
		</script>
		<script id="csinit" type="text/x-cindyscript">
			EXPONENT = 9;
			W = 2 ^ EXPONENT;

			// Ported from https://www.shadertoy.com/view/XtdSDn
			// SmoothLifeL rules
			R = [10,3]; AREA = [R_1 * R_1, R_2 * R_2] * pi;
			print(AREA);
			offsets = -1..1;

			b1 = 0.257;
			b2 = 0.336;
			d1 = 0.365;
			d2 = 0.549;

			dt = 0.3;

			alphan = 0.028;
			alpham = 0.147;

			move(from, to) := (canvas((0, 0), (W, 0), to, drawimage((0,0), (W, 0), from)));

			// adapted from https://cindyjs.org/examples/cindygl/31_fft.html
			encodealpha = 4;
			encodedelta = .5+.5*i;

			complex2color(c) := (
			  // c = c/encodealpha+encodedelta;
			  (re(c), im(c), 0)
			);

			readcomplex(x,y) := (
			  color = imagergb((0,0),(W,0),"spectral", (x,y), interpolate->false, repeat->true); //circular domain
			  // encodealpha*(color.x + i*color.y-encodedelta);
			  color.x + i * color.y;
			);

			// spatial -> spectral	
			fft() := (
				step = 2^(EXPONENT-1);
				while(step >= 1,
					colorplot((0,0), (W, 0), "spectral",
						l = #.x;
						delta = mod(l,step); //shift
						k = (l-delta) / step;
						evens = readcomplex(2*l - delta,        #.y); //even, step*(2*k)+delta
						odds  = readcomplex(2*l - delta + step, #.y); //odd, step*(2*k+1)+delta
						
						complex2color((evens + exp((-2*pi*i/W*step)*k)*odds));
					);
					step = step / 2;
				);
				step = 2^(EXPONENT-1);
				while(step >= 1,
					colorplot((0,0), (W, 0), "spectral",
						l = #.y;
						delta = mod(l,step); //shift
						k = (l-delta) / step;
						evens = readcomplex(#.x, 2*l - delta       ); //even, step*(2*k)+delta
						odds  = readcomplex(#.x, 2*l - delta + step); //odd, step*(2*k+1)+delta
						
						complex2color((evens + exp((-2*pi*i/W*step)*k)*odds));
					);
					step = step / 2;
				);
			);
			ifft() := (
				step = 2^(EXPONENT-1);
				while(step >= 1,
					colorplot((0,0), (W, 0), "spectral",
						l = #.x;
						delta = mod(l,step); //shift
						k = (l-delta) / step;
						evens = readcomplex(2*l - delta,        #.y); //even, step*(2*k)+delta
						odds  = readcomplex(2*l - delta + step, #.y); //odd, step*(2*k+1)+delta
						
						if(step == 1,
							complex2color((evens + exp((2*pi*i/W*step)*k)*odds) / W),
							complex2color((evens + exp((2*pi*i/W*step)*k)*odds))
						);
					);
					step = step / 2;
				);
				step = 2^(EXPONENT-1);
				while(step >= 1,
					colorplot((0,0), (W, 0), "spectral",
						l = #.y;
						delta = mod(l,step); //shift
						k = (l-delta) / step;
						evens = readcomplex(#.x, 2*l - delta       ); //even, step*(2*k)+delta
						odds  = readcomplex(#.x, 2*l - delta + step); //odd, step*(2*k+1)+delta
						
						if(step == 1,
							complex2color((evens + exp((2*pi*i/W*step)*k)*odds) / W),
							complex2color((evens + exp((2*pi*i/W*step)*k)*odds))
						);
					);
					step = step / 2;
				);
			);

			createimage("spatial", W, W);
			createimage("spectral", W, W);
			createimage("innerkernel", W, W);
			createimage("outerkernel", W, W);
			
			get(p) := imagergb((0,0), (W, 0), "spatial", p).r;
			colorplot("spatial", random());

			colorplot((0,0), (W,0), "spectral", 
				dist = |#-[W/2,W/2]|;
				[min(1, R.y+0.5-dist), 0, 0] / AREA_2
			);
			fft();
			colorplot((0,0), (W,0), "innerkernel", imagergb((0,0), (W,0), "spectral", #+[W/2,W/2], repeat->true));

			colorplot((0,0), (W,0), "spectral", 
				dist = |#-[W/2,W/2]|;
				[min(min(1, R.x+0.5-dist), dist-(R.y-0.5)), 0, 0] / AREA_1
			);
			fft();
			colorplot((0,0), (W,0), "outerkernel", imagergb((0,0), (W,0), "spectral", #+[W/2,W/2], repeat->true));


			sigmoid(x,a,b) := 1/(1+exp(-(x-a)*4/b));
			doublesigmoid(x, a, b, ea, eb) := sigmoid(x, a, ea) * (1 - sigmoid(x, b, eb));
			sigmoidmix(x, y, m, em) := x*(1-sigmoid(m,0.5,em)) + y*sigmoid(m,0.5,em);
			transition(integrals) := sigmoidmix(
					doublesigmoid(integrals.x, b1, b2, alphan, alphan),
					doublesigmoid(integrals.x, d1, d2, alphan, alphan), integrals.y, alpham
			);
			
			newstate(p) := (
				oldstate = get(p);
				integrals = [0,0]; // inner ring, outer ring

				forall(directproduct(offsets, offsets), delta,
					dist = |delta|;
					val = get(p+delta);
					Cinner = min(1, R.y+0.5-dist);
					Couter = min(min(1, R.x+0.5-dist), dist-(R.y-0.5));
					integrals = integrals + val * [Cinner, Couter];
				);
				(1-dt) * oldstate + dt*transition(integrals / AREA)
			);
		</script>
		<script type="text/javascript">
			CindyJS({
				scripts: "cs*",
				autoplay: true,
				ports: [{
					id: "CSCanvas",
					width: 800,
					height: 800,
					transform: [{
						visibleRect: [0, 512, 512, 0]
					}]
				}]
			});
		</script>
	</body>
</html>
